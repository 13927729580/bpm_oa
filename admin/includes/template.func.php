<?php
defined('IN_DAEM') or exit('HTTP/1.1 ACCESS FORBIDDEN!'); function template_compile($mod,$template) { $content = file_get_contents(ROOT_PATH.'templates/'.$mod.'/'.$template.'.html.php'); $content = template_parse($content); $compiledtplfile = DAEM_TEMPLATE_CACHE_ROOT.$mod.'_'.$template.'.tpl.php'; $strlen = file_put_contents($compiledtplfile, $content); @chmod($compiledtplfile, 0777); return $strlen; } function template_refresh($tplfile,$compiledtplfile) { $str = file_get_contents($tplfile); $str = template_parse($str); $strlen = file_put_contents($compiledtplfile, $str); @chmod($compiledtplfile, 0777); return $strlen; } function template_mod($mod) { $files = glob(ROOT_PATH.'/templates/'.$mod.'/*.html.php'); if(is_array($files)) { foreach($files as $tpl) { $template = str_replace('.html.php', '', basename($tpl)); template_compile($mod, $template); } } return TRUE; } function template_cache() { global $mod; foreach($mod as $mod=>$m) { template_mod($mod); } return TRUE; } function template_parse($str) { $str = preg_replace("/([\n\r]+)\t+/s","\\1",$str); $str = preg_replace("/\{template\s+([^\}]+)\}/","\n<?php include template(\\1); ?>\n",$str); $str = preg_replace("/\{include\s+([^\}]+)\}/","\n<?php include \\1; ?>\n",$str); $str = preg_replace("/\{php\s+(.+?)\}/","<?php \\1?>",$str); $str = preg_replace("/\{if\s+(.+?)\}/","<?php if(\\1) { ?>",$str); $str = preg_replace("/\{else\}/","<?php } else { ?>",$str); $str = preg_replace("/\{elseif\s+(.+?)\}/","<?php } elseif (\\1) { ?>",$str); $str = preg_replace("/\{\/if\}/","<?php } ?>",$str); $str = preg_replace("/\{loop\s+(\S+)\s+(\S+)\}/","<?php if(is_array(\\1)) foreach(\\1 AS \\2) { ?>",$str); $str = preg_replace("/\{loop\s+(\S+)\s+(\S+)\s+(\S+)\}/","\n<?php if(is_array(\\1)) foreach(\\1 AS \\2 => \\3) { ?>",$str); $str = preg_replace("/\{\/loop\}/","\n<?php } ?>\n",$str); $str = preg_replace("/\{([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*\(([^{}]*)\))\}/","<?php echo \\1;?>",$str); $str = preg_replace("/\{\\$([a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*\(([^{}]*)\))\}/","<?php echo \\1;?>",$str); $str = preg_replace("/\{(\\$[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)\}/","<?php echo \\1;?>",$str); $str = preg_replace("/\{(\\$[a-zA-Z0-9_\[\]\'\"\$\x7f-\xff]+)\}/es", "addquote('<?php echo \\1;?>')",$str); $str = preg_replace("/\{([A-Z_\x7f-\xff][A-Z0-9_\x7f-\xff]*)\}/s", "<?php echo \\1;?>",$str); $str = preg_replace("/\{(\\$[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*?\[(['\"])[^\n]+?\\2\])\s*?\}/","<?php echo \\1;?>",$str); $str = "<?php defined('IN_DAEM') or exit('Access Denied'); ?>".$str; return $str; } function addquote($var) { return str_replace("\\\"", "\"", preg_replace("/\[([a-zA-Z0-9_\-\.\x7f-\xff]+)\]/s", "['\\1']", $var)); } ?>