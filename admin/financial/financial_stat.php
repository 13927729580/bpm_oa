<?php
 define('IN_DAEM', true); include '../includes/init.php'; $userAry = get_user_realname(); $startDate = !empty($_GET['startDate']) ? $_GET['startDate'] : date('Y-m-01'); $endDate = !empty($_GET['endDate'])? $_GET['endDate'] : date('Y-m-d'); $proposer = !empty($_GET['proposer']) ? $_GET['proposer'] : ''; $approver = !empty($_GET['approver']) ? $_GET['approver'] : ''; $appStatus = !empty($_GET['appStatus']) ? $_GET['appStatus'] : ''; $inorOut = !empty($_GET['inorOut']) ? $_GET['inorOut'] : ''; $selectDay = !empty($_GET['selectDay']) ? $_GET['selectDay'] : ''; $startDateTime = strtotime($startDate); $endDateTime = strtotime($endDate); if($selectDay == 'preMonth') { $startDateTime = mktime(0,0,0,date('n',$startDateTime)-1,1,date('Y',$startDateTime)); $endDateTime = mktime(0,0,0,date('n',$endDateTime)-1,1,date('Y',$endDateTime)); $startDate = date('Y-m-d',$startDateTime); $endDate = date('Y-m-t',$endDateTime); } elseif($selectDay == 'nextMonth') { $startDateTime = mktime(0,0,0,date('n',$startDateTime)+1,1,date('Y',$startDateTime)); $endDateTime = mktime(0,0,0,date('n',$endDateTime)+1,1,date('Y',$endDateTime)); $startDate = date('Y-m-d',$startDateTime); $endDate = date('Y-m-t',$endDateTime); } if ($inorOut == '1') { $appType = !empty($_GET['appIncomeType'])? $_GET['appIncomeType'] : ''; } elseif ($inorOut == '2') { $appType = !empty($_GET['appExpenseType'])? $_GET['appExpenseType'] : ''; } $_GET['keyword'] = trim($_GET['keyword']); $keyword = !empty($_GET['keyword']) ? $_GET['keyword'] : ''; $page = $db->Get('page',1); $pageSize = $db->Get('pageSize',20); $offset = ($page-1)*$pageSize; $cond = ''; if (!empty($startDate)) { $cond .= " and unix_timestamp(application_date) >= '".strtotime($startDate.' 00:00:00')."'"; } if (!empty($endDate)) { $cond .= " and unix_timestamp(application_date) <= '".strtotime($endDate.' 23:59:59')."'"; } if ($appType > 0) { $cond .= " and type = '".$appType."'"; } if (!empty($proposer)) { $cond .= " and proposer = '".$proposer."'"; } if (!empty($approver)) { $cond .= " and approver = '".$approver."'"; } if ($appStatus > 0) { $cond .= " and status = '".$appStatus."'"; } if ($inorOut > 0) { $cond .= " and inorOut = '".$inorOut."'"; } if (!empty($keyword)) { $cond .= " and title like '%".$keyword."%' or detail like '%".$keyword."%'"; } $sql = "SELECT * FROM ".DB_DAEMDB.".".TB_SUFFIX."f_detail_record where 1=1 ".$cond." order by create_time desc limit ".$offset.",".$pageSize; $result = $db->query($sql); $dataAry = array(); while ($rows = $db->fetch_array($result)) { $dataAry[] = $rows; } $pandectInAmount = $pandectOutAmount = $pandectOutAmountNot = '0.00'; $outCount = 0; $sql = "SELECT * FROM ".DB_DAEMDB.".".TB_SUFFIX."f_detail_record where 1=1 ".$cond; $result = $db->query($sql); $reportAry = array(); while ($rows = $db->fetch_array($result)) { $reportAry[] = $rows; } foreach ($reportAry as $key=>$val) { if ($val['inorOut'] == '1') { $pandectInAmount += $val['amount']; } elseif ($val['inorOut'] == '2') { if ($val['status'] == '2') { $pandectOutAmount += $val['amount']; } elseif ($val['status'] == '1') { $outCount += 1; $pandectOutAmountNot += $val['amount']; } } } $sSql = "select count(*) as total from ".DB_DAEMDB.".".TB_SUFFIX."f_detail_record where 1=1 ".$cond; $row = $db->query_first($sSql); $total = $row['total']; $sUrl = "?startDate=$startDate&endDate=$endDate&appType=$appType&proposer=$proposer&approver=$approver&appStatus=$appStatus&keyword=$keyword&inorOut=$inorOut&"; $pagehtml = showpage($page,$pageSize,$total,$sUrl); $title = '最近12个月的各个月的收支情况'; $sql = "select DATE_FORMAT(min(application_date),'%Y-%m') as minDate,DATE_FORMAT(max(application_date),'%Y-%m') as maxDate 
		from ".DB_DAEMDB.".".TB_SUFFIX."f_detail_record where unix_timestamp(application_date)<='".strtotime($endDate)."'"; $result = $db->query_first($sql); $chartMinDate = $result['minDate']; $chartMaxDate = $result['maxDate']; $temStartDateTime = mktime(0,0,0,date('n',$endDateTime)-11,1,date('Y',$endDateTime)); $temStartDate = date('Y-m',$temStartDateTime); if ($temStartDateTime>strtotime($chartMinDate)) { $chartMinDate = date('Y-m',$temStartDateTime); } if (strtotime($chartMinDate) < strtotime(date('Y-m',strtotime(DAEM_START_DATE)))) { $chartMinDate = date('Y-m',strtotime(DAEM_START_DATE)); } $chartDateAry = array(); for ($i=0;$i<=11;$i++) { $temChartTime = mktime(0,0,0,date('n',strtotime($chartMinDate))+$i,1,date('Y',strtotime($chartMinDate))); if ($temChartTime>strtotime($chartMaxDate)) break; else { $chartDateAry[] = date('Y-m',$temChartTime); } } $chartMonthIOAry = array(); $sql = "select DATE_FORMAT(application_date,'%Y-%m') as monthDate,sum(amount) as totalAmount,inorOut 
		from ".DB_DAEMDB.".".TB_SUFFIX."f_detail_record group by monthDate,inorOut order by application_date"; $query = $db->query($sql); while ($row = $db->fetch_array($query)) { if ($row['inorOut'] == '1') { $chartMonthIOAry[$row['monthDate']]['iTotalAmount'] = $row['totalAmount']; } elseif ($row['inorOut'] == '2') { $chartMonthIOAry[$row['monthDate']]['oTotalAmount'] = $row['totalAmount']; } } foreach ($chartMonthIOAry as $key=>$val) { $chartMonthIOAry[$key]['profit'] = $val['iTotalAmount'] - $val['oTotalAmount']; } $seriesAry = $oArry = $iArry = $pArry = array(); foreach ($chartDateAry as $key=>$val) { $iArry[] = isset($chartMonthIOAry[$val]['iTotalAmount']) ? (int)$chartMonthIOAry[$val]['iTotalAmount'] : 0; $oArry[] = isset($chartMonthIOAry[$val]['oTotalAmount']) ? (int)$chartMonthIOAry[$val]['oTotalAmount'] : 0; $pArry[] = isset($chartMonthIOAry[$val]['profit']) ? $chartMonthIOAry[$val]['profit'] : 0; } $seriesAry = array( '0'=>array( 'name'=>'收入', 'data'=>$iArry ), '1'=>array( 'name'=>'支出', 'data'=>$oArry ), '2'=>array( 'name'=>'利润', 'data'=>$pArry ), ); $xvalue = json_encode($chartDateAry); $series = json_encode($seriesAry); include template();