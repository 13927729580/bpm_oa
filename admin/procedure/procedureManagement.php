<?php
 define('IN_DAEM', true); include '../includes/init.php'; include '../includes/process.func.php'; $cond = empty($_GET["pid"]) ? "" : " and process_id = '".(int)$_GET["pid"]."'"; $nodeNameInfoAry = getNodeNameInfo(); $nodeTypeInfoAry = getNodeNameInfo("type"); $departmentAry = get_department_kv(); $realnameAry = get_user_realname(); $departmentAdminAry = get_department_admin(); $dataAry = array(); $sql = "select * from case_management where 1=1 ".$cond." order by create_time DESC"; $query = $db->query($sql); while($row = $db->fetch_array($query)) { $currentLocationStr = ""; $currentLocationTmp = explode(';',$row["current_location"]); foreach ($currentLocationTmp as $key=>$val) { if(!empty($val) && $nodeTypeInfoAry[$val] != "end round mix") { $currentLocationStr .= "<a href=\"#\" onclick=\"javascript:window.location = './procedureRun.php?id=".$row['id']."&currentLocation=".$val."'\"><input style=\"margin-bottom: 2px\"  type=\"button\"  class=\"btn btn-info btn-mini\" value=\"".$nodeNameInfoAry[$val]."\" /></a>;"; } elseif($nodeTypeInfoAry[$val] == "end round mix") { $currentLocationStr .= "<a href=\"#\" onclick=\"javascript:window.location = './procedureViewer.php?id=".$row['id']."&currentLocation=".$val."'\"><input style=\"margin-bottom: 2px\"  type=\"button\"  class=\"btn btn-success btn-mini\" value=\"".$nodeNameInfoAry[$val]."\" /></a>;"; } } $currentLocationStr = trim($currentLocationStr,';'); $row["current_location"] = str_replace(';','<br />',$currentLocationStr); $currentExecutorStr = $explodeBrStr = ""; $explodeBrAry = explode(';',$row["current_executor"]); foreach($explodeBrAry as $key=>$val) { $currentExecutorTmp = explode(',',$val); foreach ($currentExecutorTmp as $kk=>$vv) { $depthValAry = explode('_',$vv); if($depthValAry[0] == 'department') { if($departmentAdminAry[$depthValAry[1]][$_SESSION['UserName']] == 1) { $currentExecutorStr .= "<input type=\"button\"  class=\"btn btn-primary btn-mini\" value=\"".$departmentAry[$depthValAry[1]]."\" disabled />,"; } else { $currentExecutorStr .= $departmentAry[$depthValAry[1]].","; } } else { if ($depthValAry[1] == $_SESSION['UserName']) { $currentExecutorStr .= "<input type=\"button\" class=\"btn btn-primary btn-mini\" value=\"".$realnameAry[$depthValAry[1]]."\" disabled />,"; } else { $currentExecutorStr .= $realnameAry[$depthValAry[1]].","; } } } $currentExecutorStr = trim($currentExecutorStr,','); $currentExecutorStr .= '<br />'; } $row["current_executor"] = $currentExecutorStr; $dataAry[$row["id"]] = $row; } include template();