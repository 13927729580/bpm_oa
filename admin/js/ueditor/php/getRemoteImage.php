<?php
 header("Content-Type: text/html; charset=utf-8"); error_reporting(E_ERROR|E_WARNING); $config = array( "savePath" => "upload/" , "allowFiles" => array( ".gif" , ".png" , ".jpg" , ".jpeg" , ".bmp" ) , "maxSize" => 3000 ); $uri = htmlspecialchars( $_POST[ 'upfile' ] ); $uri = str_replace( "&amp;" , "&" , $uri ); getRemoteImage( $uri,$config ); function getRemoteImage( $uri,$config) { set_time_limit( 0 ); $imgUrls = explode( "ue_separate_ue" , $uri ); $tmpNames = array(); foreach ( $imgUrls as $imgUrl ) { if(strpos($imgUrl,"http")!==0){ array_push( $tmpNames , "error" ); continue; } $heads = get_headers( $imgUrl ); if ( !( stristr( $heads[ 0 ] , "200" ) && stristr( $heads[ 0 ] , "OK" ) ) ) { array_push( $tmpNames , "error" ); continue; } $fileType = strtolower( strrchr( $imgUrl , '.' ) ); if ( !in_array( $fileType , $config[ 'allowFiles' ] ) || stristr( $heads[ 'Content-Type' ] , "image" ) ) { array_push( $tmpNames , "error" ); continue; } ob_start(); $context = stream_context_create( array ( 'http' => array ( 'follow_location' => false ) ) ); readfile( $imgUrl,false,$context); $img = ob_get_contents(); ob_end_clean(); $uriSize = strlen( $img ); $allowSize = 1024 * $config[ 'maxSize' ]; if ( $uriSize > $allowSize ) { array_push( $tmpNames , "error" ); continue; } $savePath = $config[ 'savePath' ]; if ( !file_exists( $savePath ) ) { mkdir( "$savePath" , 0777 ); } $tmpName = $savePath . rand( 1 , 10000 ) . time() . strrchr( $imgUrl , '.' ); try { $fp2 = @fopen( $tmpName , "a" ); fwrite( $fp2 , $img ); fclose( $fp2 ); array_push( $tmpNames , $tmpName ); } catch ( Exception $e ) { array_push( $tmpNames , "error" ); } } echo "{'url':'" . implode( "ue_separate_ue" , $tmpNames ) . "','tip':'远程图片抓取成功！','srcUrl':'" . $uri . "'}"; }