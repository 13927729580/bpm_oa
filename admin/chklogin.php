<?php
 require_once("includes/global.php"); require_once("includes/db_mysql.php"); $db = new db(); $db->connect($slaveDb); $code = $_POST['code']; $account = trim($_POST['username']); $password = md5($_POST['password']); if(strtolower($_SESSION['code']) !== strtolower($code)) { exit("4");} $sql = "select * from ".DB_DAEMDB.".".TB_SUFFIX."db_adminuser where a_account='".$account."' and a_password='".$password."'"; if($row = $db->query_first($sql)) { if($row["a_ispermit"]=="1") { echo "3"; } else { setcookie("adminaccount",$account,time()+60*60*24*365); setcookie("adminlogininfo",$row["a_logtime"].",".$row["a_logip"].",".$account,time()+60*60*24); $_SESSION['UserId'] = $row['a_id']; $_SESSION['UserName'] = $row['a_account']; $_SESSION['UserGroup'] = $row['a_gid']; $_SESSION['Department'] = $row['a_department']; $_SESSION['Number'] = $row['a_number']; $_SESSION['Tel'] = $row['a_tel']; $_SESSION['LanguageType'] = $row['a_language']; $sql = "update ".DB_DAEMDB.".".TB_SUFFIX."db_adminuser set a_logtime=".time().",a_logip='".$_SERVER['REMOTE_ADDR']."' where a_id=".$row['a_id']; $db->query($sql); echo "1"; } } else { echo "2";} if(!empty($_SERVER['HTTP_HOST'])) { $db->user_log_record($db); } $db->close(); 