<?php
 define('IN_DAEM', true); include '../includes/init.php'; include 'specialConfig.php'; $staticTplFile = ROOT_PATH.'static/'.substr(md5($_SERVER['REQUEST_URI']),10,9).'.'.substr(md5($_SERVER['QUERY_STRING']),10,9).'.html'; if(file_exists($staticTplFile) && (DAEM_TIME-@filemtime($staticTplFile)) < 86400) { } $partNumberAry = get_pic_new_code_array(); if(isset($specialConfigAry[$_SESSION['user_record']['last_visit']])) { $cond = " and A.CATGROUP_ID_PARENT = '".$specialConfigAry[$_SESSION['user_record']['last_visit']]."'"; } authority_permission($_SESSION['UserGroup']); $catalog = empty($_GET['catalog']) ? '' : $_GET['catalog']; $catalogGBK = iconv('utf-8','gb2312',$catalog); $catgroup_id = empty($_GET['CATGROUP_ID']) ? '' : $_GET['CATGROUP_ID']; $dataAry = array(); $sql = "SELECT CC.identifier CHILD_IDENTIFIER,A.NAME,A.CATGROUP_ID_PARENT,A.CATGROUP_ID,A.PARENTNAME,PC.IDENTIFIER PARENT_IDENTIFIER FROM (
       SELECT CHILD.CATGROUP_ID,CHILD.NAME,CATGRPREL.CATGROUP_ID_PARENT,PARENT.NAME AS PARENTNAME, LEVEL
       FROM CATGRPREL
      LEFT JOIN CATGRPDESC CHILD ON ( CHILD.CATGROUP_ID=CATGRPREL.CATGROUP_ID_CHILD AND CHILD.LANGUAGE_ID=-7)
      LEFT JOIN CATGRPDESC PARENT ON ( PARENT.CATGROUP_ID=CATGRPREL.CATGROUP_ID_PARENT AND PARENT.LANGUAGE_ID=-7)
      START WITH CATGROUP_ID_PARENT IN (SELECT CATGROUP_ID FROM CATTOGRP)
      CONNECT BY PRIOR CATGROUP_ID_CHILD = CATGROUP_ID_PARENT ORDER BY LEVEL ASC,CATGRPREL.CATGROUP_ID_PARENT DESC
 )A
      LEFT JOIN CATGROUP CC ON CC.CATGROUP_ID = A.catgroup_id LEFT JOIN CATGROUP PC ON PC.CATGROUP_ID = A.CATGROUP_ID_PARENT where PARENTNAME = '".$catalogGBK."'".$cond."
      ORDER BY A.CATGROUP_ID_PARENT,A.CATGROUP_ID "; $query = $db2->query($sql); while($row = $db2->fetch_array($query)) { foreach($row as $key=>$val) { $row[$key] = mb_convert_encoding($val,'utf-8','gb2312'); $row[$key]=str_replace('润?变频','润珮变频',$row[$key]); } $dataAry[] = $row; } $sortByParentAry = array(); foreach($dataAry as $key=>$val) { $sortByParentAry[$val['PARENTNAME']][$val['NAME']] = $val; } $catgroupIdStr = ''; foreach($sortByParentAry[$catalog] as $key=>$val) { $catgroupIdStr .= "'".$val['CATGROUP_ID']."',"; } $catgroup_id = empty($catgroup_id) ? trim($catgroupIdStr,',') : $catgroup_id; $catgroupAry = array(); $sql = "select * from xcatentry where catentry_id in (select catentry_id from CATGPENREL where catgroup_id in (".$catgroup_id."))  and published = 1"; $query = $db2->query($sql); while($row = $db2->fetch_array($query)) { foreach($row as $key=>$val) { $row[$key] = mb_convert_encoding($val,'utf-8','gb2312'); $row[$key]=str_replace('润?变频','润珮变频',$row[$key]); } $row['PARTNUMBER_BEFORE'] = $row['PARTNUMBER']; $row['PARTNUMBER'] = empty($partNumberAry[$row['PARTNUMBER']]) ? $row['PARTNUMBER'] : $partNumberAry[$row['PARTNUMBER']]; $catgroupAry[] = $row; } $queryStr = ''; foreach($catgroupAry as $key=>$val) { $queryStr .= "'".$val['CATENTRY_ID']."',"; } $queryStr = trim($queryStr,','); $productInfoAry = $productTmpInfoAry = $paramDefineAry = array(); $sql = "select * from catentryattr c left join attr a on a.attr_id = c.attr_id left join attrval av on av.attrval_id = c.attrval_id where c.catentry_id in (".$queryStr.")"; $query = $db2->query($sql); while($row = $db2->fetch_array($query)) { foreach($row as $key=>$val) { $row[$key] = iconv('gb2312','utf-8',$val); } $productTmpInfoAry[$row['CATENTRY_ID']][] = $row; } $sql = "select * from catentryattr c left join attr a on a.attr_id = c.attr_id where c.catentry_id in (".$queryStr.")"; $query = $db2->query($sql); while($row = $db2->fetch_array($query)) { foreach($row as $key=>$val) { $row[$key] = iconv('gb2312','utf-8',$val); } if(!isset($paramDefineAry[$row['CATENTRY_ID']])) { $paramDefineAry[$row['ATTR_ID']] = $row['IDENTIFIER']; } } unset($paramDefineAry['193']);unset($paramDefineAry['194']);unset($paramDefineAry['195']);unset($paramDefineAry['136']);unset($paramDefineAry['137']);unset($paramDefineAry['229']);unset($paramDefineAry['251']);unset($paramDefineAry['252']);unset($paramDefineAry['253']);unset($paramDefineAry['256']);unset($paramDefineAry['260']); $paramCount = count($paramDefineAry); foreach($productTmpInfoAry as $key=>$depth1) { foreach($depth1 as $kk=>$vv) { $productInfoAry[$key][$vv['ATTR_ID']] = $vv['IDENTIFIER']; } } $paramDataAry = process_data_param_into_section($paramDefineAry,$productInfoAry); $filterAry = array(); foreach($_GET as $key=>$val) { $findSign = stristr($key,'ATTR_ID_'); if(!empty($findSign) && count($findSign) >0) { if($val != '0' && trim($val) != '') { $$key = $val; $filerKey = str_replace('ATTR_ID_','',$key); $filterAry[$filerKey] = $val; } } } foreach($filterAry as $key=>$val) { foreach($productInfoAry as $kk=>$vv) { if($vv[$key] != $val) { foreach($catgroupAry as $kkk=>$vvv) { if($vvv['CATENTRY_ID'] == $kk) { unset($catgroupAry[$kkk]); } } } } } include_once './product.func.php'; $productCountAry = get_product_count_num(); $productDepthCountAry = array(); foreach($productCountAry as $key=>$depth1) { foreach($depth1['list'] as $k=>$depth2) { foreach($depth2['list'] as $kk=>$depth3) { $productDepthCountAry[$depth3['module_sign']] = $depth3; } } } $staticTplFile = ROOT_PATH.'static/'.substr(md5($_SERVER['REQUEST_URI']),10,9).'.'.substr(md5($_SERVER['QUERY_STRING']),10,9).'.html'; { include template('product','catalog3'); } 