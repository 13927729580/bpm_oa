<?php
 define('IN_DAEM', true); include '../includes/init.php'; include './templateConfig.php'; $userAry = get_user_realname(); $userAllowAry = get_user_realname('0'); if(!empty($_POST)) { $templateId = $_POST["templateId"]; $templateName = $_POST["templateName"]; $outboard = $_POST["outboard"]; $certificate = $_POST["certificate"]; $productCatalog = $_POST["productCatalog"]; $catalog = $_POST["catalog"]; $TemplateCatalog = $_POST["TemplateCatalog"]; $paramName = $_POST["paramName"]; $approver = $_POST["approver"]; $paramName = str_replace(",undefined","",$paramName); $paramName = str_replace("undefined,","",$paramName); $builder = $_SESSION["UserName"]; $fileBasicPath = file_upload(DAEM_DATA_ROOT."upload"); $filePath = DAEM_PATH."data/upload/".basename($fileBasicPath); if (empty($filePath)) { Gourl("请上传CDR文件!", "", "-1"); } $fileContent = file_get_contents($fileBasicPath); $hex = ""; for($i=0;$i<=strlen($fileContent);$i++){ $asc = ord(substr($fileContent,$i,1)); $hex .= dechex($asc); } $fileContent = $hex; error_reporting(E_ALL); $serverName = "(local)"; $connectionOptions = array("Database"=>"DRSDatabase","UID"=>"sa","PWD"=>"12345678"); $conn2 = sqlsrv_connect( $serverName, $connectionOptions); if( $conn2 === false ) { print_r(sqlsrv_errors());die; } $fileStream = fopen($fileBasicPath, "r"); $options = array("SendStreamParamsAtExec"=>0); $sql = "INSERT INTO [DRSDatabase].[dbo].[TemplateEntity]
            ([templateId],[templateName],[outboard],[certificate],[productCatalog],[catalog],[TemplateCatalog],[paramName],[approver],[filePath],[fileName],[builder],[approverStatus],[createDateTime],[fileContent]) VALUES
            ('".$templateId."','".$templateName."','".$outboard."','".$certificate."','".$productCatalog."','".$catalog."','".$TemplateCatalog."','".$paramName."','".$approver."','".$filePath."','".$_FILES['file']['name']."', '".$builder."','0', '".date('Y-m-d H:i:s')."',?);SELECT SCOPE_IDENTITY() AS PhotoID"; $uploadPic = sqlsrv_prepare($conn2, $sql, array( array(&$fileStream, SQLSRV_PARAM_IN, SQLSRV_PHPTYPE_STREAM(SQLSRV_ENC_BINARY), SQLSRV_SQLTYPE_VARBINARY('max'))), $options); if( $uploadPic === false ) { print_r(sqlsrv_errors());die;} if( sqlsrv_execute($uploadPic) === false ) { print_r(sqlsrv_errors());die; } sqlsrv_send_stream_data( $uploadPic); $next_result = sqlsrv_next_result($uploadPic); if( $next_result === false ) { print_r(sqlsrv_errors());die; } while($res = sqlsrv_next_result($uploadPic)){ echo $res;die; } sqlsrv_free_stmt( $uploadPic ); sqlsrv_close( $conn2 ); gourl("添加成功,请等待审批通过后生效!", "templateList.php"); } include template(); function CheckDataIntoTemplate($outboard, $productCatalog, $certificate, $catalog, $TemplateCatalog) { if(empty($outboard) || empty($productCatalog) || empty($certificate) || empty($catalog) || empty($TemplateCatalog)) { return "出口，产品类，认证,类型,模板分类 不能为空!"; } try { $conn = new PDO( "sqlsrv:Server=(local);Database=DRSDatabase", "sa", "12345678"); $conn->setAttribute( PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION ); } catch( PDOException $e ) { die( "Error connecting to SQL Server" ); } $dataAry = array(); $query = "select * from [DRSDatabase].[dbo].[TemplateEntity] where outboard = '".$outboard."'
                and  productCatalog ='".$productCatalog."'
                and certificate = '".$certificate."'
                and catalog = '".$catalog."'
                and TemplateCatalog = '".$TemplateCatalog."'"; $stmt = $conn->query( $query ); while ( $row = $stmt->fetch( PDO::FETCH_ASSOC ) ){ $row['fileName'] = ltrim(strrchr($row['filePath'],'//'),'\/'); $dataAry[] = $row; } if (count($dataAry) != 0) { return "已存在：出口，产品类，认证,类型,模板分类 相同模板，请直接使用!"; } else { return "1"; } } function bstr2bin($input) { if (!is_string($input)) return null; $value = unpack('H*', $input); $value = str_split($value[1], 1); $bin = ''; foreach ($value as $v) { $b = str_pad(base_convert($v, 16, 2), 4, '0', STR_PAD_LEFT); $bin .= $b; } return $bin; } function getBytes($string) { $bytes = array(); for($i = 0; $i < strlen($string); $i++){ $bytes[] = ord($string[$i]); } return $bytes; } function toStr($bytes) { $str = ''; foreach($bytes as $ch) { $str .= chr($ch); } return $str; }