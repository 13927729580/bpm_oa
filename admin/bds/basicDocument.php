<?php
 define('IN_DAEM', true); include "../includes/init.php"; include DAEM_CONFIG_ROOT.'basicDocumentConfig.php'; $cond = ''; $store3 = empty($_GET["store3"]) ? "tw" : $_GET["store3"]; if(!in_array($store3,$_SESSION["store3Ary"]) && $_SESSION["pb"] != "") gourl("账户未开通相关模块访问，请联系管理员!","",-1); if(!empty($_SESSION["pb"])) { $cond .= " and (pb is null or pb = '".$_SESSION["pb"]."') "; } else { $cond .= " and pb is null "; } $basicDocumentControlStatusAry = array( 'new' => '受控', 'old' => '历史', 'baofei' => '报废', ); $DOCNUMBER = $_GET["DOCNUMBER"]; $DOCNAME = $_GET["DOCNAME"]; $DOCNUMBERCHANGE = $_GET["DOCNUMBERCHANGE"]; $ITEMNUMBER = $_GET["ITEMNUMBER"]; $STATE = $_GET["STATE"]; $STORE2 = $_GET["STORE2"]; $ITEMTYPE = $_GET["ITEMTYPE"]; $ITEMGROUP = $_GET["ITEMGROUP"]; $DOCSIZE = $_GET["DOCSIZE"]; $CHANGEMOULDFLAG = $_GET["CHANGEMOULDFLAG"]; $RECEPTDEPTNAME = $_GET["RECEPTDEPTNAME"]; $MADEPROUDFLAG = $_GET["MADEPROUDFLAG"]; $CREATOR = $_GET["CREATOR"]; $NOTE = $_GET["NOTE"]; if(!empty($DOCNUMBER)) { $cond .= " and DOCNUMBER = '".$DOCNUMBER."'"; } if(!empty($DOCNAME)) { $cond .= " and DOCNAME like '%".$DOCNAME."%'"; } if(!empty($DOCNUMBERCHANGE)) { $cond .= " and DOCNUMBERCHANGE = '".$DOCNUMBERCHANGE."'"; } if(!empty($ITEMNUMBER)) { $cond .= " and ITEMNUMBER like '%".$ITEMNUMBER."%'"; } if(!empty($STATE)) { $cond .= " and STATE = '".$STATE."'"; } if(!empty($STORE2)) { $cond .= " and STORE2 = '".$STORE2."'"; } if(!empty($ITEMGROUP)) { $cond .= " and ITEMGROUP like '%".$ITEMGROUP."%'"; } if(!empty($DOCSIZE)) { $cond .= " and DOCSIZE = '".$DOCSIZE."'"; } if(!empty($CHANGEMOULDFLAG)) { $cond .= " and CHANGEMOULDFLAG = '".$CHANGEMOULDFLAG."'"; } if(!empty($RECEPTDEPTNAME)) { $cond .= " and RECEPTDEPTNAME like '%".$RECEPTDEPTNAME."%'"; } if(!empty($MADEPROUDFLAG)) { $cond .= " and MADEPROUDFLAG = '".$MADEPROUDFLAG."'"; } if(!empty($CREATOR)) { $cond .= " and CREATOR like '%".$CREATOR."%'"; } if(!empty($NOTE)) { $cond .= " and NOTE like '%".$NOTE."%'"; } if(!empty($_GET["startDate"]) || !empty($_GET["endDate"])) { $startDate = empty($_GET["startDate"]) ? "1990-01-01": $_GET["startDate"]; $endDate = empty($_GET["endDate"]) ? date('Y-m-d') : $_GET["endDate"]; $startDateInt = (int)date('Ymd',strtotime($startDate)); $endDateInt = (int)date('Ymd',strtotime($endDate)); $cond .= " and date between  '".$startDateInt."' and '".$endDateInt."'"; } if(empty($_GET["startDate"]) && empty($_GET["endDate"]) && empty($_GET["DOCNUMBER"]) && empty($_GET["DOCNAME"]) && empty($_GET["DOCNUMBERCHANGE"]) && empty($_GET["ITEMNUMBER"]) && empty($_GET["STORE2"]) && empty($_GET["STATE"]) && empty($_GET["ITEMTYPE"]) && empty($_GET["ITEMGROUP"]) && empty($_GET["DOCSIZE"]) && empty($_GET["CHANGEMOULDFLAG"]) && empty($_GET["RECEPTDEPTNAME"]) && empty($_GET["MADEPROUDFLAG"]) && empty($_GET["CREATOR"]) && empty($_GET["NOTE"])) { $startDate = empty($_GET["startDate"]) ? date('Y-01-01'): $_GET["startDate"]; $endDate = empty($_GET["endDate"]) ? date('Y-m-d') : $_GET["endDate"]; $startDateInt = (int)date('Ymd',strtotime($startDate)); $endDateInt = (int)date('Ymd',strtotime($endDate)); $cond .= " and date between  '".$startDateInt."' and '".$endDateInt."'"; } $page = $db->Get('page',1); $pageSize = $db->Get('pageSize',20); $offset = ($page-1)*$pageSize; $sql = "select * from BDMINFO where store3 = '".$store3."' ".$cond."  order by date desc limit ".$offset.",".$pageSize; $dataAry = $tmpAry = array(); $query = $db->query($sql); while($row = $db->fetch_array($query)) { $row["RECEPTDEPTNAME"] = explode('.',$row["RECEPTDEPTNAME"]); $row['MXLINK'] = ""; if(strstr($row['DOCNUMBER'],"MX") && !empty($row['ITEMNUMBER'])) { if($_SESSION["pb"] == "") { $row['MXLINK'] = "http://10.1.1.123:7201/baan6query/tcibd/tibom0510s001.jsp?id=".$row['ITEMNUMBER']."&date=".$row['DATE']."&citgf=+&citgt=ZZZZZZ&reptype=1&comp=400"; } elseif($_SESSION["pb"] == "CS") { $row['MXLINK'] = "http://10.2.8.174:8780/baanwebs/tcibd/tibom0510s000.jsp?id=".$row['ITEMNUMBER']."&date=".$row['DATE']."&citgf=+&citgt=ZZZZZZ&reptype=3&comp=751"; } } $itemNumberStr = ''; $tmpItemNumberAry = explode(';',$row["ITEMNUMBER"]); foreach($tmpItemNumberAry as $key=>$val) { if($_SESSION["pb"] == "") { $itemNumberStr .= "<a href='http://10.1.1.123:7201/baan6query/tiitm/tiitm0502s001.jsp?item=".$val."&comp=400' target='_blank'>".$val."</a><br />"; } elseif($_SESSION["pb"] == "CS") { $itemNumberStr .= "<a href='http://10.2.8.174:8780/baanwebs/tiitm/tiitm0502s001.jsp?item=".$val."&comp=751' target='_blank'>".$val."</a><br />"; } } $row["ITEMNUMBER"] = $itemNumberStr; if(strstr($row['CREATOR'],',')) { $tmpAry = explode(',',$row['CREATOR']); $row['creatorMail'] = trim($tmpAry[0]); $row['CREATOR'] = trim($tmpAry[1]); } $row['ADDONSPATH'] = trim($row['ADDONSPATH']); if($row["pb"] == null) { $row['mainPath'] = DAEM_PATH."admin/bds/downloadfile.php?f=".urlencode($row['ADDONSPATH']); $row['changeFilePath'] = DAEM_PATH."admin/bds/downloadfile.php?f=".urlencode($row['ADDONSNAME']); $row['tiffilePath'] = DAEM_PATH."admin/bds/downloadfile.php?f=".urlencode($row['TIFFILE']); $row['processPath'] = DAEM_PATH."admin/bds/downloadfile.php?f=".urlencode($row['STORE7']); } elseif($row["pb"] == "CS") { $row['mainPath'] = DAEM_PATH."data/upload/CS/".urlencode($row['ADDONSPATH']); $row['changeFilePath'] = DAEM_PATH."data/upload/CS/".urlencode($row['ADDONSNAME']); $row['tiffilePath'] = DAEM_PATH."data/upload/CS/".urlencode($row['TIFFILE']); $row['processPath'] = DAEM_PATH."data/upload/CS/".urlencode($row['STORE7']); } $dataAry[$row["ID"]] = $row; } $sql = "select count(*) as TOTAL from BDMINFO t where store3 = '".$store3."' ".$cond; $result = $db->query_first($sql); $total = $result["TOTAL"]; $url = "?store3=$store3&startDate=$startDate&endDate=$endDate&DOCNUMBER=$DOCNUMBER&DOCNAME=$DOCNAME&DOCNUMBERCHANGE=$DOCNUMBERCHANGE&ITEMNUMBER=$ITEMNUMBER&STATE=$STATE&STORE2=$STORE2&ITEMTYPE=$ITEMTYPE&ITEMGROUP=$ITEMGROUP&DOCSIZE=$DOCSIZE&CHANGEMOULDFLAG=$CHANGEMOULDFLAG&RECEPTDEPTNAME=$RECEPTDEPTNAME&MADEPROUDFLAG=$MADEPROUDFLAG&CREATOR=$CREATOR&NOTE=$NOTE&"; $pagehtml = showpage($page,$pageSize,$total,$url); include template("bds","basicDocument2"); 