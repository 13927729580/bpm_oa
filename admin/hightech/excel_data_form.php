<?php
 define('IN_DAEM', true); include '../includes/init.php'; require_once '../includes/excel/Classes/PHPExcel.php'; require_once "./excelBIConfig.php"; $realNameAry = get_user_realname(); $templateSignNameAry = array(); $sql = "select * from excel_template_struct"; $query = $db->query($sql); while($row = $db->fetch_array($query)) { $templateSignNameAry[$row["sign"]] = $row["name"]; } $templateSign = $_GET['templateSign']; $id = $_GET["id"]; $act = empty($id) ? "add" : "edit"; $actName = ($act == "add") ? "添加" : "修改"; if(!empty($templateSign)) { $sql = "select * from excel_template_struct where sign = '".$templateSign."'"; $result = $db->query_first($sql); $dataAry = json_decode($result["template_struct"],true); foreach($dataAry as $key=>$val) { foreach($val as $k=>$v) { $dataAry[$key][$k]["name"] = base64_decode($dataAry[$key][$k]["name"]); $dataAry[$key][$k]["value"] = base64_decode($dataAry[$key][$k]["value"]); if($elementTypeConfigAry[$dataAry[$key][$k]["type"]]) { $sql = "select config_data from form_element_defined where form_element_sign = '".$dataAry[$key][$k]["formElement"]."'"; $result = $db->query_first($sql); $formElementDataAry = unserialize($result["config_data"]); $dataAry[$key][$k]["formElementDataAry"] = $formElementDataAry; } $elementPropertyInfoAry = elementPropertyInfo($dataAry[$key][$k]["property"]); if(!empty($elementPropertyInfoAry)) { $dataAry[$key][$k]["propertyInfo"] = $elementPropertyInfoAry; $dataAry[$key][$k]["propertyInfo"]["defaultValue"] = parse_params_return($elementPropertyInfoAry["default_value_config"]); } $elementPropertyInfoAry = ''; } } $maxCountNum = innerArrayCount($dataAry)*2; if($id>0) { $sql = "select * from $templateSign where id = ".$id; $data = $db->query_first($sql); } if($_POST["act"] == "add" || $_POST["act"] == "edit" ) { if(!empty($_FILES)) { $depositFilePath = array(); foreach($_FILES as $key=>$val) { $fileBasicPath = file_upload_param(DAEM_DATA_ROOT."upload/attachment",$key); $filePath = "data/upload/attachment/".basename($fileBasicPath); $tmpFileTypeAry = explode('.',$val["name"]); $depositFilePath[$key] = _json_encode(array("fileName"=>$val["name"],"type"=>$tmpFileTypeAry[1],"path"=>$filePath)); } } else { foreach($_POST as $key=>$val) { if(strpos($val, "@@") !== false) { $tmpDepositFilePathAry = explode("@@",$val); $key = rtrim($key,"@"); $depositFilePath[$key] = _json_encode(array("fileName"=>$tmpDepositFilePathAry[0],"path"=>$tmpDepositFilePathAry[1])); } } } if(empty($depositFilePath)){$depositFilePath=array();} $_POST = array_merge($depositFilePath,$_POST); if($_POST["act"] == "add") { $opSql = "insert into ".$templateSign." set "; } else { $opSql = "update ".$templateSign." set "; } foreach($dataAry as $key=>$val) { foreach($val as $k=>$v) { if(($v["isNeed"] == '1') && (empty($_POST[$v["param"]])) ) { gourl($v["param"]."--".$v["name"]." 不能为空，请返回填写后直接导入数据!","",-1); } elseif($_POST[$v["param"]] != '') { if($v["type"] == "textarea-plugin") { $opSql .= $v["param"] . "='" . $_REQUEST[$v["param"]] . "',"; } else { $opSql .= $v["param"] . "='" . $_POST[$v["param"]] . "',"; } } } } if($_POST["act"] == "add") { $title = !empty($_POST["title"]) ? $_POST["title"] : $templateSignNameAry[$_GET["templateSign"]] . "_" . $realNameAry[$_SESSION["UserName"]] . "_" . date("Ymd"); } else { $title = !empty($data["title"]) ? $data["title"] : $templateSignNameAry[$_GET["templateSign"]] . "_" . $realNameAry[$_SESSION["UserName"]] . "_" . date("Ymd"); } $opSql .= "title = '".$title."',"; $opSql .= "builder = '".$_SESSION["UserName"]."',"; $opSql .= "status = '1',"; $opSql .= "create_time = '".DAEM_TIME."',"; $opSql = rtrim($opSql,","); if($_POST["act"] == "edit") { $opSql .= " where id  = ".$id; } if($db->query($opSql)) { gourl("操作成功!","dataInfoManagement.php?templateSign=".$templateSign); } else { gourl("操作失败！请检查数据后到数据上传功能中选择该模板重试，如果问题仍然存在，请联系管理员!","",-1); } } } function innerArrayCount($dataAry) { $maxCountNum = 0; foreach($dataAry as $key=>$val) { if(count($val)>$maxCountNum) { $maxCountNum = count($val); } } return $maxCountNum; } function elementPropertyInfo($propertySign) { if(empty($propertySign)) return; global $db; $sql = "select * from element_property_extra where element_property_sign = '".$propertySign."'"; $result = $db->query_first($sql); return $result; } include template();