<?php
 define('IN_DAEM', true); include '../includes/init.php'; require_once '../includes/excel/Classes/PHPExcel.php'; require_once "./excelBIConfig.php"; $templateSignNameAry = array(); $sql = "select * from excel_template_struct"; $query = $db->query($sql); while($row = $db->fetch_array($query)) { $templateSignNameAry[$row["sign"]] = $row["name"]; } $formElementConfigAry = array(); $sql = "select * from form_element_defined"; $query = $db->query($sql); while($row = $db->fetch_array($query)) { $formElementConfigAry[$row["form_element_sign"]] = unserialize($row["config_data"]); } $templateSign = $_GET['templateSign']; $act = $_POST["act"]; if(!empty($templateSign)) { $startDate = !empty($_GET['startDate']) ? $_GET['startDate'] : date('Y-m-01'); $endDate = !empty($_GET['endDate'])? $_GET['endDate'] : date('Y-m-d'); $approver = !empty($_GET['approver']) ? $_GET['approver'] : ''; $appStatus = !empty($_GET['appStatus']) ? $_GET['appStatus'] : ''; $selectDay = !empty($_GET['selectDay']) ? $_GET['selectDay'] : ''; $startDateTime = strtotime($startDate); $endDateTime = strtotime($endDate); if($selectDay == 'preMonth') { $startDateTime = mktime(0,0,0,date('n',$startDateTime)-1,1,date('Y',$startDateTime)); $endDateTime = mktime(0,0,0,date('n',$endDateTime)-1,1,date('Y',$endDateTime)); $startDate = date('Y-m-d',$startDateTime); $endDate = date('Y-m-t',$endDateTime); } elseif($selectDay == 'nextMonth') { $startDateTime = mktime(0,0,0,date('n',$startDateTime)+1,1,date('Y',$startDateTime)); $endDateTime = mktime(0,0,0,date('n',$endDateTime)+1,1,date('Y',$endDateTime)); $startDate = date('Y-m-d',$startDateTime); $endDate = date('Y-m-t',$endDateTime); } $cond = ""; if (!empty($startDate)) { $cond .= " and create_time >= '".strtotime($startDate.' 00:00:00')."'"; } if (!empty($endDate)) { $cond .= " and create_time <= '".strtotime($endDate.' 23:59:59')."'"; } $sql = "select * from excel_template_struct where sign = '".$templateSign."'"; $result = $db->query_first($sql); $dataAry = json_decode($result["template_struct"],true); foreach($dataAry as $key=>$val) { foreach($val as $k=>$v) { $dataAry[$key][$k]["name"] = base64_decode($dataAry[$key][$k]["name"]); $dataAry[$key][$k]["value"] = base64_decode($dataAry[$key][$k]["value"]); } } $maxCountNum = innerArrayCount($dataAry)*2; $dataInfoAry = array(); $sql = "select * from ".$templateSign." where 1=1 $cond order by id desc"; $query = $db->query($sql); while($row = $db->fetch_array($query)) { $dataInfoAry[] = $row; } $sql = "select count(*) as totalNum from ".$templateSign; $result = $db->query_first($sql); $totalNum = $result["totalNum"]; } $sign_key = $_GET["sign_key"]; $status = $_GET["status"]; if (!empty($sign_key) && !empty($status)) { $sql = "select id from ".$templateSign." where id = '" . $sign_key . "'"; $result = $db->query_first($sql); if (isset($appStateAry[$status])) { if ($result['id'] > 0) { $sql = "update ".$templateSign."
					set status = '" . $status . "',
						approver = '" . $_SESSION['UserName'] . "',
						approval_date = '" . date('Y-m-d') . "'
					where id = '" . $sign_key . "'"; if ($db->query($sql)) { gourl('事务更新成功', '', -1); } else { gourl('事务更新失败，请联系管理员', '', -1); } } } } function innerArrayCount($dataAry) { $maxCountNum = 0; foreach($dataAry as $key=>$val) { if(count($val)>$maxCountNum) { $maxCountNum = count($val); } } return $maxCountNum; } include template();