<?php
 class db2 { public $querynum = 0; public $link = 0; public $query_id = 0; public $record = array(); public $errdesc = ""; public $errno = 0; public $reporterror = 1; public $dbAry = array(); function connect( $dbArray='' ) { if (empty($dbArray)) { echo ('The info of sql is empty!');exit; } else { $this->dbAry = $dbArray; $dbArray = null; } if(!$this->link=@oci_connect( $this->dbAry['name'], $this->dbAry['pass'],$this->dbAry['host'],'zhs16gbk')) { echo ('Can not connect to ORACLE server');exit; } } function fetch_array($query) { $row = oci_fetch_array($query,OCI_ASSOC); foreach($row as $key=>$val) { $row[$key] = iconv('gb2312','utf-8',$val); } return $row; } function query($sql, $type = '') { $sql = trim($sql); $dStartTime = $this->microtimeFloat(); $sErrorCotent = ""; $query=oci_parse($this->link,$sql); oci_execute($query,OCI_DEFAULT); $this->writeLog($sql,$sErrorCotent,$dStartTime); $this->querynum++; return $query; } function query2($sql) { $sql = trim($sql); $dStartTime = $this->microtimeFloat(); $sErrorCotent = ""; $query=oci_parse($this->link,$sql); oci_execute($query, OCI_DEFAULT); $committed = oci_commit($this->link); if (!$committed) { $error = oci_error($this->link); echo 'Commit failed. Oracle reports: ' . $error['message']; } oci_free_statement($query); } function writeLog($sql,$sErrorCotent="",$dStartTime=0) { if(!defined('GLOBAL_DEBUG_LEVEL') || GLOBAL_DEBUG_LEVEL == 0) return 0; $dEndTime = $this->microtimeFloat(); $iSQLTime = intval($dEndTime)-intval($dStartTime); $iDay = "admin_do_oracle_log_".@date('Y-m-d'); $sFile = $iDay.'.log'; $sIp = $this->get_ip(); if($sIp == "127.0.0.1") $sPathFile = DAEM_DATA_ROOT . 'cache/log/' . $sFile; else $sPathFile = '/home/admin_game/adminLog/' . $sFile; $dCreateDate = @date('Y-m-d H:i:s'); $sUrl = $_SERVER['PHP_SELF']; $sIp = $this->get_ip(); $sUserName = $_SESSION['UserName']; if(empty($sUserName) || empty($_SERVER['HTTP_HOST'])) return false; $sCotent = "Date:".$dCreateDate."\r\nIP:".$sIp."\r\nUserName:".$sUserName."\r\nUrl:".$sUrl."\r\nSQLTime:".$iSQLTime."\r\n"; if(!empty($sErrorCotent)) $sCotent .=$sErrorCotent."\r\n"; $sCotent .= "DeBugSQL:".$sql."\r\n\r\n"; file_put_contents($sPathFile,$sCotent,FILE_APPEND); } function get_ip() { if(getenv('HTTP_CLIENT_IP') && strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')) { $PHP_IP = getenv('HTTP_CLIENT_IP'); } elseif(getenv('HTTP_X_FORWARDED_FOR') && strcasecmp(getenv('HTTP_X_FORWARDED_FOR'), 'unknown')) { $PHP_IP = getenv('HTTP_X_FORWARDED_FOR'); } elseif(getenv('REMOTE_ADDR') && strcasecmp(getenv('REMOTE_ADDR'), 'unknown')) { $PHP_IP = getenv('REMOTE_ADDR'); } elseif(isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], 'unknown')) { $PHP_IP = $_SERVER['REMOTE_ADDR']; } preg_match("/[\d\.]{7,15}/", $PHP_IP, $ipmatches); unset($PHP_IP); return $ipmatches[0] ? $ipmatches[0] : 'unknown'; } function user_log_record($db) { date_default_timezone_set("Asia/Shanghai"); $sUserName = $_SESSION['UserName']; if(empty($sUserName) || empty($_SERVER['HTTP_HOST'])) return false; $dRecordTime = @date('Y-m-d H:i:s'); $sUrl = $_SERVER['PHP_SELF']; $sUrl = str_replace("/".SITE_DIR."/admin/","",$sUrl); if($sUrl == "chklogin.php") { $iMenuId = 0; $sMenuName = "登录"; } else if($sUrl == "logout.php") { $iMenuId = -1; $sMenuName = "退出系统"; } else if($sUrl == "password.php") { $iMenuId = -2; $sMenuName = "修改密码"; } else { $sSql = "select m_id,m_name from ".DB_DAEMDB.".".TB_SUFFIX."db_menu where m_url like '%$sUrl%' limit 1"; $row = $db->query_first($sSql); if(empty($row)) return false; $iMenuId = $row['m_id']; $sMenuName = $row['m_name']; } $sIP = $this->get_ip(); $sSql = "insert into ".DB_DAEMDB.".".TB_SUFFIX."log_operation_record set dRecordTime='$dRecordTime',sIP='$sIP',sUserName='$sUserName',sUrl='$sUrl',iMenuId='$iMenuId',sMenuName='$sMenuName'"; return $db->query($sSql); } function microtimeFloat() { list($usec, $sec) = explode(" ", microtime()); return ((float)$usec + (float)$sec); } } ?>