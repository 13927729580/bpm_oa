<?php
 define('IN_DAEM', true); include_once './init/global.php'; include_once './init/ftp.func.php'; require_once("./init/db_mysql.php"); ini_set("max_execution_time",86400); set_time_limit(86400); $db = new db(); $db->connect($slaveDb); ob_end_clean(); echo str_pad('',1024); $sql = "select * from bdminfo where  pb = 'CS' and date >= '20170101' order by id asc"; $query = $db->query($sql); while($row = $db->fetch_array($query)) { echo "编号：<span style='color: #0000ff;font-weight: bold;'>".$row["ID"] ."</span> -- <span style='font-weight: bold;'>". date('Y-m-d H:i:s')."</span> 移动图号 <span style='color: red;font-weight: bold;'>".$row["DOCNUMBER"]."</span> 下挂文档： <br />"; if(!empty($row["TIFFILE"])) { echo "下载签审扫描tif文件：".$row["TIFFILE"]."  ---  状态："; rsyncDocumentFile($row["TIFFILE"]); }else { echo "<span style='color: green;font-weight: bold;'>无签审扫描tif文件!</span><br />"; } if(!empty($row["ADDONSNAME"])) { echo "下载更改单文件：".$row["ADDONSNAME"]."  ---  状态："; rsyncDocumentFile($row["ADDONSNAME"]); }else { echo "<span style='color: green;font-weight: bold;'>无更改单文件!</span><br />"; } if(!empty($row["ADDONSPATH"])) { echo "下载主图档文件：".$row["ADDONSPATH"]."  ---  状态："; rsyncDocumentFile($row["ADDONSPATH"]); } else { echo "<span style='color: green;font-weight: bold;'>无主图档文件!</span><br />"; } if(!empty($row["STORE7"])) { echo "下载流程签审文件：".$row["STORE7"]."  ---  状态："; rsyncDocumentFile($row["STORE7"]); } else { echo "<span style='color: green;font-weight: bold;'>无主流程签审文件!</span><br />"; } echo "<br />"; flush(); } function rsyncDocumentFile($filePath) { global $ftpCSBaseConfig; $status = ftp_download_file($ftpCSBaseConfig,$filePath); if($status) { mkdir(DAEM_DATA_ROOT."upload/CS/".dirname($filePath),0777,true); copy($status,DAEM_DATA_ROOT."upload/CS/".$filePath); unlink($status); echo "<span style='color: red;font-weight: bold;'>成功同步文件!</span><br />"; } else { echo "<span style='color: green;font-weight: bold;'>图档文件缺失!</span><br />"; } } 